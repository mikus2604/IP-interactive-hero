<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Interactive Hero Map</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #000;
    overflow: hidden;
    font-family: sans-serif;
  }

  svg {
    display: block;
    width: 100%;
    height: 100%;
  }

  .land {
    fill: none;
    stroke: #1e90ff;
    stroke-width: 0.5px;
    opacity: 0.85;
  }

  .graticule {
    fill: none;
    stroke: #1e90ff;
    stroke-width: 0.3px;
    opacity: 0.5;
  }

  .visitor {
    fill: #fff;
    opacity: 0.8;
  }

  .user-dot {
    fill: #fff;
  }

  .user-pulse {
    fill: none;
    stroke: #fff;
    stroke-width: 1;
    transform-origin: center;
    transform-box: fill-box;
    animation: pulse 3s ease-out infinite;
  }

  @keyframes pulse {
    0% { transform: scale(0.2); opacity: 0.8; }
    100% { transform: scale(3); opacity: 0; }
  }
</style>
</head>
<body>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/topojson@3"></script>
<script>
(async function(){
  const width = window.innerWidth,
        height = window.innerHeight;
  const svg = d3.select('body').append('svg')
      .attr('width', width)
      .attr('height', height);

  const projection = d3.geoOrthographic()
      .scale(Math.min(width, height)/2.1)
      .translate([width/2, height/2])
      .clipAngle(90);

  const path = d3.geoPath(projection);
  const graticule = d3.geoGraticule10();

  const g = svg.append('g');
  const grat = g.append('path').datum(graticule).attr('class','graticule');
  const landPath = g.append('path').attr('class','land');
  const visitorsGroup = g.append('g').attr('class','visitors');
  const userGroup = g.append('g').attr('class','user');

  let userLocation = null;
  const visitorData = [
    {lat:40.7128, lon:-74.0060},
    {lat:34.0522, lon:-118.2437},
    {lat:51.5074, lon:-0.1278},
    {lat:35.6895, lon:139.6917},
    {lat:-33.8688, lon:151.2093},
    {lat:48.8566, lon:2.3522},
    {lat:55.7558, lon:37.6176},
    {lat:-23.5505, lon:-46.6333},
    {lat:52.52, lon:13.405},
    {lat:19.4326, lon:-99.1332},
    {lat:37.7749, lon:-122.4194},
    {lat:1.3521, lon:103.8198},
    {lat:41.9028, lon:12.4964},
    {lat:59.3293, lon:18.0686},
    {lat:28.6139, lon:77.2090},
    {lat:-34.6037, lon:-58.3816},
    {lat:31.2304, lon:121.4737},
    {lat:43.6532, lon:-79.3832},
    {lat:60.1699, lon:24.9384},
    {lat:25.2048, lon:55.2708}
  ];

  const visitorDots = visitorsGroup.selectAll('circle')
      .data(visitorData)
      .enter()
      .append('circle')
      .attr('class','visitor')
      .attr('r',2);

  const world = await d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json');
  const land = topojson.mesh(world, world.objects.countries, (a,b) => a !== b);

  fetch('https://ipapi.co/json/')
    .then(res => res.json())
    .then(data => {
      userLocation = {lat: data.latitude, lon: data.longitude};
      renderUser();
    })
    .catch(err => console.error('IP fetch error:', err));

  function renderMap(){
    grat.attr('d', path);
    landPath.datum(land).attr('d', path);
    visitorDots
      .attr('cx', d => projection([d.lon, d.lat])[0])
      .attr('cy', d => projection([d.lon, d.lat])[1]);
    if(userLocation){
      const p = projection([userLocation.lon, userLocation.lat]);
      userGroup.attr('transform', `translate(${p[0]},${p[1]})`);
    }
  }

  function renderUser(){
    if(!userLocation) return;
    userGroup.selectAll('*').remove();
    userGroup.append('circle').attr('class','user-dot').attr('r',2);
    userGroup.append('circle').attr('class','user-pulse').attr('r',5);
  }

  renderMap();
  d3.timer((elapsed) => {
    projection.rotate([elapsed * 0.02, -20]);
    renderMap();
  });
})();
</script>
</body>
</html>
